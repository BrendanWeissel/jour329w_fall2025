<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CNS Tags Browser</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="search-row">
    <header class="main-header">
        <h1>CNS Tag Browser</h1>
        <p class="catchline">Explore Maryland news, topics, and trends with Capital News Service</p>
    </header>
		<input type="text" id="search" placeholder="Search tags..." />
		<div id="dropdownContainer"></div>
	</div>
	<div class="category-filter-row">
		<label for="categoryFilter" style="font-size:1.2em;color:#ffb347;margin-right:0.5em;">Category:</label>
		<select id="categoryFilter" style="font-size:1.1em;padding:0.4em 1em;border-radius:1em;border:none;background:#222;color:#ffb347;">
			<option value="all">All</option>
		</select>
	</div>
	<div id="tagsGrid" class="tags-grid"></div>
	<div id="storiesSection" style="margin-top:2em;"></div>
		<script>
		// --- Debounce helper ---
		function debounce(fn, delay) {
			let t;
			return (...args) => {
				clearTimeout(t);
				t = setTimeout(() => fn(...args), delay);
			};
		}

		// --- Tag rendering ---
		let lastSearch = '';
		let lastSort = 'count';
		let lastCategory = 'all';
		let allCategories = [];

		function highlight(text, search) {
			if (!search) return text;
			const re = new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'ig');
			return text.replace(re, '<mark>$1</mark>');
		}

			function renderTags() {
				// Get search/sort/category from URL if present
				const params = new URLSearchParams(window.location.search);
				let search = params.get('search') || document.getElementById('search').value;
				let sort = params.get('sort') || 'count';
				let category = params.get('category') || 'all';
				lastSearch = search;
				lastSort = sort;
				lastCategory = category;
				document.getElementById('search').value = search;
				document.getElementById('categoryFilter').value = category;

				// Build categories if not already
				if (!allCategories.length) {
					const categoryDefs = [
						{ name: 'Politics', keywords: ['politic', 'election', 'senate', 'congress', 'governor', 'legislature', 'law', 'bill', 'campaign', 'vote'] },
						{ name: 'Cities', keywords: ['baltimore', 'annapolis', 'rockville', 'city', 'town', 'village'] },
						{ name: 'Counties', keywords: ['county', 'montgomery', 'prince george', 'howard', 'anne arundel', 'frederick', 'carroll', 'harford', 'charles', 'calvert'] },
						{ name: 'Education', keywords: ['school', 'college', 'university', 'education', 'student', 'teacher', 'classroom'] },
						{ name: 'Health', keywords: ['health', 'hospital', 'doctor', 'nurse', 'covid', 'vaccine', 'mental', 'medical'] },
						{ name: 'Crime & Justice', keywords: ['crime', 'police', 'court', 'judge', 'prison', 'jail', 'justice', 'law enforcement'] },
						{ name: 'Environment', keywords: ['environment', 'climate', 'water', 'bay', 'river', 'forest', 'wildlife', 'nature'] },
						{ name: 'Transportation', keywords: ['transport', 'bus', 'train', 'metro', 'road', 'highway', 'traffic', 'transit'] },
						{ name: 'Business', keywords: ['business', 'company', 'industry', 'commerce', 'startup', 'market', 'trade'] },
						{ name: 'Sports', keywords: ['sport', 'team', 'game', 'athlete', 'coach', 'league', 'tournament'] },
						{ name: 'Arts & Culture', keywords: ['art', 'music', 'theater', 'film', 'museum', 'culture', 'festival'] },
						{ name: 'Government', keywords: ['government', 'agency', 'public', 'official', 'mayor', 'council'] },
						{ name: 'People', keywords: ['person', 'people', 'profile', 'biography', 'student', 'teacher'] },
						{ name: 'Science & Tech', keywords: ['science', 'tech', 'technology', 'research', 'innovation', 'data', 'computer'] },
						{ name: 'Housing', keywords: ['housing', 'home', 'apartment', 'real estate', 'rent', 'tenant'] },
						{ name: 'Food', keywords: ['food', 'restaurant', 'bar', 'cafe', 'grocery', 'market'] },
						{ name: 'Religion', keywords: ['religion', 'church', 'faith', 'mosque', 'temple', 'synagogue'] },
						{ name: 'Military', keywords: ['military', 'army', 'navy', 'air force', 'marine', 'veteran'] },
						{ name: 'Immigration', keywords: ['immigration', 'immigrant', 'refugee', 'asylum'] },
						{ name: 'Other', keywords: [] }
					];
					allCategories = ['all', ...categoryDefs.map(c => c.name)];
					// Populate dropdown
					const catSel = document.getElementById('categoryFilter');
					catSel.innerHTML = '<option value="all">All</option>' + categoryDefs.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
				}

				// Filter and sort
				let filtered = window.tags.filter(tag =>
					tag.name && tag.count !== 0 && tag.name.toLowerCase().includes(search.toLowerCase())
				);
				if (category !== 'all') {
					// Use same categoryDefs as above
					const catDef = allCategories.find(c => c === category);
					const categoryDefs = [
						{ name: 'Politics', keywords: ['politic', 'election', 'senate', 'congress', 'governor', 'legislature', 'law', 'bill', 'campaign', 'vote'] },
						{ name: 'Cities', keywords: ['baltimore', 'annapolis', 'rockville', 'city', 'town', 'village'] },
						{ name: 'Counties', keywords: ['county', 'montgomery', 'prince george', 'howard', 'anne arundel', 'frederick', 'carroll', 'harford', 'charles', 'calvert'] },
						{ name: 'Education', keywords: ['school', 'college', 'university', 'education', 'student', 'teacher', 'classroom'] },
						{ name: 'Health', keywords: ['health', 'hospital', 'doctor', 'nurse', 'covid', 'vaccine', 'mental', 'medical'] },
						{ name: 'Crime & Justice', keywords: ['crime', 'police', 'court', 'judge', 'prison', 'jail', 'justice', 'law enforcement'] },
						{ name: 'Environment', keywords: ['environment', 'climate', 'water', 'bay', 'river', 'forest', 'wildlife', 'nature'] },
						{ name: 'Transportation', keywords: ['transport', 'bus', 'train', 'metro', 'road', 'highway', 'traffic', 'transit'] },
						{ name: 'Business', keywords: ['business', 'company', 'industry', 'commerce', 'startup', 'market', 'trade'] },
						{ name: 'Sports', keywords: ['sport', 'team', 'game', 'athlete', 'coach', 'league', 'tournament'] },
						{ name: 'Arts & Culture', keywords: ['art', 'music', 'theater', 'film', 'museum', 'culture', 'festival'] },
						{ name: 'Government', keywords: ['government', 'agency', 'public', 'official', 'mayor', 'council'] },
						{ name: 'People', keywords: ['person', 'people', 'profile', 'biography', 'student', 'teacher'] },
						{ name: 'Science & Tech', keywords: ['science', 'tech', 'technology', 'research', 'innovation', 'data', 'computer'] },
						{ name: 'Housing', keywords: ['housing', 'home', 'apartment', 'real estate', 'rent', 'tenant'] },
						{ name: 'Food', keywords: ['food', 'restaurant', 'bar', 'cafe', 'grocery', 'market'] },
						{ name: 'Religion', keywords: ['religion', 'church', 'faith', 'mosque', 'temple', 'synagogue'] },
						{ name: 'Military', keywords: ['military', 'army', 'navy', 'air force', 'marine', 'veteran'] },
						{ name: 'Immigration', keywords: ['immigration', 'immigrant', 'refugee', 'asylum'] },
						{ name: 'Other', keywords: [] }
					];
					const catObj = categoryDefs.find(c => c.name === category);
					if (catObj) {
						filtered = filtered.filter(tag => catObj.keywords.some(kw => tag.name.toLowerCase().includes(kw)));
					}
				}
				filtered.sort((a, b) => sort === 'count' ? b.count - a.count : a.name.localeCompare(b.name));

				// Update URL
				const url = new URL(window.location);
				url.searchParams.set('search', search);
				url.searchParams.set('sort', sort);
				url.searchParams.set('category', category);
				window.history.replaceState({}, '', url);

				   // Only show top 10 tags by count
				   const top10 = filtered.slice(0, 10);
				   renderTagsGrid(top10, search);
			}

		function renderTagsGrid(tags, search) {
			const grid = document.getElementById('tagsGrid');
			grid.innerHTML = '';
			grid.style.display = 'grid';
			grid.className = 'tags-grid';
			tags.slice(0, 60).forEach(tag => {
				let displayName = tag.name;
				if (displayName.startsWith('#')) displayName = displayName.slice(1).trim();
				displayName = displayName.replace(/([a-z])([A-Z])/g, '$1 $2');
				displayName = displayName.replace(/\b\w/g, c => c.toUpperCase());
				const a = document.createElement('a');
				a.href = tag.link;
				a.target = '_blank';
				a.className = 'tag-grid-item';
				a.innerHTML = highlight(displayName, search);
				grid.appendChild(a);
			});
			document.getElementById('tagsGrid').style.display = 'grid';
			document.getElementById('tagsGrid').style.gridTemplateColumns = 'repeat(auto-fit, minmax(160px, 1fr))';
			document.getElementById('tagsGrid').style.gap = '1.1em';
			// Hide pills list
			if (document.getElementById('tagsList')) document.getElementById('tagsList').style.display = 'none';
		}

		function renderTagsCozy(tags, search) {
			// Pills view
			let tagsList = document.getElementById('tagsList');
			if (!tagsList) {
				tagsList = document.createElement('ul');
				tagsList.id = 'tagsList';
				document.body.insertBefore(tagsList, document.getElementById('storiesSection'));
			}
			tagsList.innerHTML = '';
			tags.slice(0, 60).forEach(tag => {
				const li = document.createElement('li');
				li.style.margin = '1.2rem 0';
				li.style.textAlign = 'center';
				li.style.listStyle = 'none';
				const a = document.createElement('a');
				let displayName = tag.name;
				if (displayName.startsWith('#')) displayName = displayName.slice(1).trim();
				displayName = displayName.replace(/([a-z])([A-Z])/g, '$1 $2');
				displayName = displayName.replace(/\b\w/g, c => c.toUpperCase());
				a.innerHTML = highlight(displayName, search);
				a.href = tag.link;
				a.target = '_blank';
				a.style.textDecoration = 'none';
				a.style.color = '#0074d9';
				a.className = 'tag-pill';
				li.appendChild(a);
				tagsList.appendChild(li);
			});
			tagsList.style.display = 'block';
			document.getElementById('tagsGrid').style.display = 'none';
		}

			// --- Debounced search ---
			document.getElementById('search').addEventListener('input', debounce(function(e) {
				renderTags();
			}, 250));

			// --- Category filter ---
			document.getElementById('categoryFilter').addEventListener('change', function(e) {
				lastCategory = e.target.value;
				renderTags();
			});

		// Initial load
		fetch("../../../data/tags.json")
			.then(res => res.json())
			.then(data => {
				window.tags = data;
				renderTags();
			});
		</script>
</body>
</html>
